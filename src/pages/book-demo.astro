---
import Layout from '../layouts/Layout.astro';
import { Icon } from 'astro-icon/components';
---

<Layout 
  title="Agendar Demo - Xendra Pro"
  description="Agenda una demostración personalizada y descubre cómo los agentes de voz de Xendra Pro pueden transformar tu atención al cliente."
>
  <div class="min-h-screen bg-gradient-to-b from-payflo-gray/50 to-white py-16 px-4 sm:px-6 lg:px-8">
    <div class="max-w-3xl mx-auto">
      <!-- Header -->
      <div class="text-center mb-12">
        <h1 class="text-4xl font-bold mb-4">Agendar una Demo</h1>
        <p class="text-xl text-gray-600">
          Descubre cómo nuestros agentes de voz pueden transformar tu atención al cliente
        </p>
      </div>

      <!-- Multi-step Form -->
      <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
        
        <!-- Success Message -->
        <div id="success-message" class="hidden p-12 text-center">
            <div class="w-16 h-16 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-2">¡Solicitud Enviada!</h3>
            <p class="text-gray-600 mb-8">Gracias por tu interés. Nos pondremos en contacto contigo pronto para coordinar la demo.</p>
            <a href="/" class="inline-block px-6 py-3 bg-payflo-purple text-white rounded-lg hover:bg-payflo-purple/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-payflo-purple/20">
                Volver al inicio
            </a>
        </div>

        <!-- Error Message Container -->
        <div id="form-error-message" class="hidden mx-8 mt-8 p-4 bg-red-50 border border-red-200 rounded-lg flex items-start gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div>
                <h4 class="text-sm font-medium text-red-800">Error al enviar</h4>
                <p id="error-text" class="text-sm text-red-600 mt-1"></p>
            </div>
        </div>

        <!-- Progress Steps -->
        <div class="flex border-b border-gray-100" id="progress-steps">
          <div class="flex-1 p-4 text-center bg-payflo-purple/5 border-r border-gray-100 current-step" data-step="1">
            <div class="flex items-center justify-center mb-2">
              <div class="w-8 h-8 rounded-full bg-payflo-purple text-white flex items-center justify-center">
                <span>1</span>
              </div>
            </div>
            <span class="text-sm font-medium">Contacto</span>
          </div>
          <div class="flex-1 p-4 text-center" data-step="2">
            <div class="flex items-center justify-center mb-2">
              <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center">
                <span>2</span>
              </div>
            </div>
            <span class="text-sm font-medium">Agendar</span>
          </div>
        </div>

        <!-- Form Steps -->
        <form id="demo-form" class="p-8">
          <!-- Step 1: Contact Details -->
          <div class="step-content" id="step-1">
            <div class="space-y-6">
              <div class="grid grid-cols-2 gap-6">
                <div>
                  <label for="first-name" class="block text-sm font-medium text-gray-700 mb-1">
                    Nombre
                  </label>
                  <input
                    type="text"
                    id="first-name"
                    name="first-name"
                    required
                    class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-payflo-purple/20 focus:border-payflo-purple"
                  />
                  <p class="text-red-500 text-xs mt-1 hidden error-message" id="error-first-name">Por favor ingresa tu nombre</p>
                </div>
                <div>
                  <label for="last-name" class="block text-sm font-medium text-gray-700 mb-1">
                    Apellido
                  </label>
                  <input
                    type="text"
                    id="last-name"
                    name="last-name"
                    required
                    class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-payflo-purple/20 focus:border-payflo-purple"
                  />
                  <p class="text-red-500 text-xs mt-1 hidden error-message" id="error-last-name">Por favor ingresa tu apellido</p>
                </div>
              </div>

              <div>
                <label for="work-email" class="block text-sm font-medium text-gray-700 mb-1">
                  Email Corporativo
                </label>
                <input
                  type="email"
                  id="work-email"
                  name="work-email"
                  required
                  class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-payflo-purple/20 focus:border-payflo-purple"
                  placeholder="tu@empresa.com"
                />
                <p class="text-red-500 text-xs mt-1 hidden error-message" id="error-work-email">Por favor ingresa un email válido</p>
              </div>

              <div>
                <label for="job-title" class="block text-sm font-medium text-gray-700 mb-1">
                  Cargo
                </label>
                <input
                  type="text"
                  id="job-title"
                  name="job-title"
                  class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-payflo-purple/20 focus:border-payflo-purple"
                />
              </div>

              <div>
                <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">
                  Teléfono
                </label>
                <input
                  type="tel"
                  id="phone"
                  name="phone"
                  class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-payflo-purple/20 focus:border-payflo-purple"
                />
              </div>
            </div>
          </div>

          <!-- Step 2: Schedule Demo -->
          <div class="step-content hidden" id="step-2">
            <div class="space-y-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Rango preferido
                </label>
                <div class="grid grid-cols-2 gap-4">
                  <button
                    type="button"
                    class="px-4 py-3 rounded-lg border border-gray-200 hover:border-payflo-purple hover:bg-payflo-purple/5 focus:outline-none focus:ring-2 focus:ring-payflo-purple/20"
                    data-date="morning"
                  >
                    Por la mañana
                  </button>
                  <button
                    type="button"
                    class="px-4 py-3 rounded-lg border border-gray-200 hover:border-payflo-purple hover:bg-payflo-purple/5 focus:outline-none focus:ring-2 focus:ring-payflo-purple/20"
                    data-date="afternoon"
                  >
                    Por la tarde
                  </button>
                </div>
                <p class="text-red-500 text-xs mt-1 hidden error-message" id="error-date">Por favor selecciona un rango</p>
              </div>

              <div>
                <label for="message" class="block text-sm font-medium text-gray-700 mb-1">
                  Información Adicional
                </label>
                <textarea
                  id="message"
                  name="message"
                  rows="9"
                  class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-payflo-purple/20 focus:border-payflo-purple"
                  placeholder="Cuéntanos sobre tus necesidades específicas o preguntas..."
                ></textarea>
              </div>
            </div>
          </div>

          <!-- Form Navigation -->
          <div class="mt-8 flex justify-between">
            <button
              type="button"
              id="prev-step"
              class="hidden px-6 py-3 border border-gray-200 rounded-lg text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-payflo-purple/20"
            >
              Anterior
            </button>
            <button
              type="button"
              id="next-step"
              class="ml-auto px-6 py-3 bg-payflo-purple text-white rounded-lg hover:bg-payflo-purple/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-payflo-purple/20"
            >
              Siguiente
            </button>
            <button
              type="submit"
              id="submit-form"
              class="hidden ml-auto px-6 py-3 bg-payflo-purple text-white rounded-lg hover:bg-payflo-purple/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-payflo-purple/20"
            >
              Agendar Demo
            </button>
          </div>
        </form>
      </div>

      <!-- Trust Badges -->
      <div class="mt-12 text-center">
        <p class="text-sm text-gray-600 mb-4">Confiado por empresas líderes de software</p>
        <div class="flex justify-center space-x-8">
          <Icon name="ph:shield-check-duotone" class="h-6 w-6 text-gray-400" />
          <Icon name="ph:lock-key-duotone" class="h-6 w-6 text-gray-400" />
          <Icon name="ph:certificate-duotone" class="h-6 w-6 text-gray-400" />
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  document.addEventListener('astro:page-load', () => {
    const form = document.getElementById('demo-form') as HTMLFormElement | null;
    const steps = document.querySelectorAll<HTMLElement>('.step-content');
    const progressSteps = document.querySelectorAll<HTMLElement>('#progress-steps > div');
    const prevButton = document.getElementById('prev-step') as HTMLButtonElement | null;
    const nextButton = document.getElementById('next-step') as HTMLButtonElement | null;
    const submitButton = document.getElementById('submit-form') as HTMLButtonElement | null;
    let currentStep = 1;

    function updateSteps() {
      if (!prevButton || !nextButton || !submitButton) return;

      steps.forEach((step, index) => {
        if (index + 1 === currentStep) {
          step.classList.remove('hidden');
        } else {
          step.classList.add('hidden');
        }
      });

      progressSteps.forEach((step, index) => {
        const stepCircle = step.querySelector('div');
        if (!stepCircle) return;

        if (index + 1 === currentStep) {
          step.classList.add('bg-payflo-purple/5');
          stepCircle.classList.remove('bg-gray-200', 'text-gray-600');
          stepCircle.classList.add('bg-payflo-purple', 'text-white');
        } else if (index + 1 < currentStep) {
          step.classList.add('bg-payflo-purple/5');
          stepCircle.classList.remove('bg-gray-200', 'text-gray-600');
          stepCircle.classList.add('bg-payflo-purple', 'text-white');
        } else {
          step.classList.remove('bg-payflo-purple/5');
          stepCircle.classList.add('bg-gray-200', 'text-gray-600');
          stepCircle.classList.remove('bg-payflo-purple', 'text-white');
        }
      });

      prevButton.style.display = currentStep === 1 ? 'none' : 'block';
      nextButton.style.display = currentStep === 2 ? 'none' : 'block';
      submitButton.style.display = currentStep === 2 ? 'block' : 'none';
    }

    if (prevButton) {
      prevButton.style.display = currentStep === 1 ? 'none' : 'block';
    }
    if (nextButton) {
      nextButton.style.display = currentStep === 2 ? 'none' : 'block';
    }
    if (submitButton) {
      submitButton.style.display = currentStep === 2 ? 'block' : 'none';
    }

    // Form validation
    function showError(id: string, show: boolean) {
      const errorElement = document.getElementById(`error-${id}`);
      const inputElement = document.getElementById(id);
      
      if (errorElement) {
        if (show) {
          errorElement.classList.remove('hidden');
        } else {
          errorElement.classList.add('hidden');
        }
      }
      
      if (inputElement) {
        if (show) {
          inputElement.classList.add('border-red-500', 'focus:ring-red-200', 'focus:border-red-500');
          inputElement.classList.remove('border-gray-200', 'focus:ring-payflo-purple/20', 'focus:border-payflo-purple');
        } else {
          inputElement.classList.remove('border-red-500', 'focus:ring-red-200', 'focus:border-red-500');
          inputElement.classList.add('border-gray-200', 'focus:ring-payflo-purple/20', 'focus:border-payflo-purple');
        }
      }
    }

    function validateStep(step: number): boolean {
      let isValid = true;

      if (step === 1) {
        const firstName = (document.getElementById('first-name') as HTMLInputElement)?.value;
        const lastName = (document.getElementById('last-name') as HTMLInputElement)?.value;
        const email = (document.getElementById('work-email') as HTMLInputElement)?.value;
        
        if (!firstName) {
          showError('first-name', true);
          isValid = false;
        } else {
          showError('first-name', false);
        }

        if (!lastName) {
          showError('last-name', true);
          isValid = false;
        } else {
          showError('last-name', false);
        }

        if (!email) {
          showError('work-email', true);
          isValid = false;
        } else {
          // Validate email format
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(email)) {
             const errorEmail = document.getElementById('error-work-email');
             if (errorEmail) errorEmail.textContent = 'Por favor ingresa un email válido';
             showError('work-email', true);
             isValid = false;
          } else {
             showError('work-email', false);
          }
        }
        
        return isValid;
      }
      
      if (step === 2) {
        const selectedDate = document.querySelector('[data-date].border-payflo-purple');
        
        if (!selectedDate) {
          const errorDate = document.getElementById('error-date');
          if (errorDate) errorDate.classList.remove('hidden');
          isValid = false;
        } else {
          const errorDate = document.getElementById('error-date');
          if (errorDate) errorDate.classList.add('hidden');
        }
        
        return isValid;
      }
      
      return true;
    }

    // Next button click handler
    if (nextButton) {
      nextButton.addEventListener('click', () => {
        if (validateStep(currentStep)) {
          currentStep++;
          updateSteps();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      });
    }

    // Previous button click handler
    if (prevButton) {
      prevButton.addEventListener('click', () => {
        if (currentStep > 1) {
          currentStep--;
          updateSteps();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      });
    }

    // Form submission handler
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Hide previous errors
        const errorContainer = document.getElementById('form-error-message');
        if (errorContainer) errorContainer.classList.add('hidden');

        if (validateStep(currentStep)) {
          const submitBtn = document.getElementById('submit-form') as HTMLButtonElement;
          const originalText = submitBtn.innerText;
          submitBtn.innerText = "Enviando...";
          submitBtn.disabled = true;

          // Collect data
          const formData = new FormData(form);
          const data = Object.fromEntries(formData.entries());
          
          // Add selected range manually
          const selectedRangeBtn = document.querySelector('[data-date].border-payflo-purple') as HTMLElement;
          if (selectedRangeBtn) {
            data.range = selectedRangeBtn.dataset.date || '';
          }

          try {
            const response = await fetch('/api/send-email', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(data),
            });

            if (response.ok) {
              // Show success message
              const successMessage = document.getElementById('success-message');
              const progressSteps = document.getElementById('progress-steps');
              
              if (successMessage) successMessage.classList.remove('hidden');
              if (form) form.classList.add('hidden');
              if (progressSteps) progressSteps.classList.add('hidden');
              
              window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
              const errorData = await response.json();
              throw new Error(errorData.details || errorData.error || 'Error en el envío');
            }
          } catch (error: any) {
            console.error(error);
            // Show error message in UI
            const errorText = document.getElementById('error-text');
            if (errorContainer && errorText) {
                errorText.textContent = error.message || 'Hubo un error al enviar el formulario. Por favor intenta nuevamente.';
                errorContainer.classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                alert(`Hubo un error al enviar el formulario: ${error.message}`);
            }
          } finally {
            submitBtn.innerText = originalText;
            submitBtn.disabled = false;
          }
        }
      });
    }

    // Initialize dropdowns with native select behavior
    const dropdowns = document.querySelectorAll('select');
    dropdowns.forEach(dropdown => {
      dropdown.addEventListener('change', () => {
        const selectedOption = dropdown.options[dropdown.selectedIndex];
        if (selectedOption.value) {
          dropdown.classList.add('text-gray-900');
        } else {
          dropdown.classList.remove('text-gray-900');
        }
      });
    });

    // Date selection
    const dateButtons = document.querySelectorAll<HTMLButtonElement>('[data-date]');
    dateButtons.forEach(button => {
      button.addEventListener('click', () => {
        dateButtons.forEach(btn => {
          btn.classList.remove('border-payflo-purple', 'bg-payflo-purple/5');
        });
        button.classList.add('border-payflo-purple', 'bg-payflo-purple/5');
        
        // Clear error if exists
        const errorDate = document.getElementById('error-date');
        if (errorDate) errorDate.classList.add('hidden');
      });
    });
  });
</script>

<style>
  /* Custom styles for form elements */
  select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.5rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
    padding-right: 2.5rem;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    appearance: none;
  }
</style>
